# WebSocketDS

Translation is not finished yet

Перевод ещё не закончен Русская версия [здесь](./README_RUS.md)

## Introduction

For successful compilation TANGO libraries and a c++11 compiler must be installed. **libboost-system libboost-system-dev libssl** must also be installed.
The directory has Makefile for g++. This Makefile was generated by POGO, and is suitable in most cases of TANGO standard assembly. For successful running of Makefile, there must be a directory, defined in MAKE_ENV = /usr/local/share/pogo/preferences (default. Correct if necessary).

As a default, compilation runs in OPTIMIZED (-O2) mode. For compilation in DEBUG (-g -D_DEBUG) mode, start make RTYPE=debug, inputting make clean

## server mode

More about [server mode](./server_mode/README.md)

Makefile is in the directory `./server_mode/`

## client mode

More about [client mode](./client_mode/README.md)

Makefile is in the directory `./client_mode/`

## list of possible values in property Options

The property `Options` (array of strings) for the TANGO device has the format `opt1` or `opt2 = val`, where `opt` is the option name, `val` is the value, if required.

List of possible options:

- **group** - No value. Использование групп девайс серверов. Свойство `DeviceServer` должно быть задано в соответствующем для групп формате.

- **uselog** - No value. Использование записи в журнал при выполении команд. [Подробнее ниже](#использование-записи-в-журнал-при-выполении-команд)

- **useoldjson**- No value. Если добавлен этот ключ, Для команд и чтения атрибутов будут ответы старого типа

- **tident**- С дополнительным значением. Используемый тип авторизации. Используются два типа , `permission_www` ([подробности ниже](#авторизация-методом-permission_www)), а также `smpl` - SIMPLE (он же используется по умолчанию)

- **command_name_for_check_user**- С дополнительным значением. Использование иного имени команды для аутентификации. По умолчанию `check_user`. Пример: `command_name_for_check_user=НОВОЕ_ИМЯ_МЕТОДА`

- **command_name_for_check_permission**- С дополнительным значением. Использование иного имени команды для авторизации. По умолчанию `check_permissions`. Пример: `command_name_for_check_permission=НОВОЕ_ИМЯ_МЕТОДА`

- **command_name_for_log**- С дополнительным значением. Использование иного имени команды для записи логов. По умолчанию `send_log_command_ex`. Пример: `command_name_for_log=НОВОЕ_ИМЯ_МЕТОДА`

- **maxnconn**- Максимальное число соединений. Если будет достигнут предел, последующие соединения будут прерваны ошибкой `400 Bad Request`. Если задано значение 0, количество соединений не будет ограничено.

- **maxbuffsize**- Максимальный размер буфера для каждого соединения в КиБ. Значение по умолчанию 1000. Возможные значения от 1 до 10000 (если указать значения не входящие в заданный диапазон будет выставлено значение по умолчанию). При превышении заданного максимального размера буфера, соединение будет прервано со стороны сервера;

## Authorization and authentication

To execute the command, the client must be authenticated.

Authorization and authentication are performed in the Device `AuthDS`.

login and password must be written to URL `ws(wss)://ip_or_hostname:port?login=zzz&password=zzz`

or after connection:

```json
{
  "type_req": "change_user_smpl",
  "id": "Request id",
  "login": "login",
  "password": "password"
}
```

Device `AuthDS` must contain method `check_user(const Tango::DevVarStringArray (*argin)` and return true or false.
If you want to change the name of method, you need to define `command_name_for_check_user=NEW_NAME_FOR_CHECK_USER_METHOD` in Property "Options"

- **argin[0]** - login
- **argin[1]** - password

Also the server should contain the method `check_permissions(const Tango::DevVarStringArray *argin)`, used for authentication. return true or false.

If you want to change the name of method, you need to define `command_name_for_check_permission=NEW_NAME_FOR_CHECK_PERMISSIONS_METHOD` in Property "Options"

- **argin[0]** — Device name
- **argin[1]** — Running command
- **argin[2]** — Ip
- **argin[3]** — login

## Logging

o activate this feature, you need to define `uselog` in Property "Options"

Device `AuthDS` must contain method `send_log_command_ex(const Tango::DevVarStringArray *argin)`

- **id** - autoincrement
- **argin[0]** = timestamp_string (UNIX_TIMESTAMP)
- **argin[1]** = login
- **argin[2]** = deviceName (or group)
- **argin[3]** = IP
- **argin[4]** = commandName
- **argin[5]** = command in Json (вводимая команда в json формате)
- **argin[6]** = statusBool (true if successful, otherwise false)
- **argin[7]** = isGroup (true if group, otherwise false)

## precision options

Precision options выставляются по разному, в зависимости от адресата.

Для запросов, выставлением дополнительного ключа `precision`, формат которого зависит от типа запроса. Это либо объект, либо значение.

Для выставления значений точности атрибутов из `Property`, к имени атрибута в свойстве следует добавить `;prec=N`, где N - это требуемая точность. Пример: `AttrDevDouble;prec=10`

Следует учитывать максимально возможную точность. Подробнее про double можно посмотреть [здесь](https://en.wikipedia.org/wiki/Double-precision_floating-point_format), про float [здесь](https://en.wikipedia.org/wiki/Floating-point_arithmetic).

It is also possible to set additional formatting flags:

- **precf** - Setting the flag std::fixed
- **precs** - Setting the flag std::scientific

Example output for 1476379200 (type double with precision = 10)

- **prec=10** - output: 1476379200
- **precf=10** - output: 1476379200.0000000000
- **precs=10** - output: 1.4763792000e+009

Example output for 1476379200 (type double with precision by default)

- **precf** - output: 1476379200.000000
- **precs** - output: 1.476379e+009

## error output

```json
{
  "event": "error",
  "type_req": "Type of request",
  "id_req": "Request id. If it was",
  "err_mess": "Or string, or array of string or object",
  "type_err": "type of error"
}
```

`type_err` - type of error. Possible types of errors [listed below](#types-of-errors)

### types of errors

- **init_failed** - Ошибка инициализации прослушиваемого девайса
- **auth_check** - Ошибка аутентификации. Неверный логин или пароль
- **auth_perm** - Ошибка аутентификации. Нет доступа
- **auth_server_err** - Ошибка аутентификации. Сервер недоступен
- **is_not_valid** - Неправильный запрос
- **not_supp** - Нет поддержки. Например для команды с данным типом аргумента
- **not_supp_in_curr** - Нет поддержки в текущем режиме
- **unknown_req_type** - Неизвестный типа запроса
- **check_request** - Проверить запрос. Неправильный формат, или не найден необходимый ключ
- **tango_exc** - TANGO exception
- **unavailable_devs** - All device unavailable
- **event_err** - Исключение из событийных данных
- **check_code** - Данный тип ошибки не должен выдаваться при нормальной работе
- **subscr_not_found** - Не найдена подписка с данным id. Может возникнуть при отписке от событий
- **commun_failed** - Tango::CommunicationFailed
- **conn_failed** - Tango::ConnectionFailed
- **unknown_exc** - Исключение неизвестного типа
- **not_subscr_yet** - Ещё нет подписчиков. Возникает при командах по управлению подписками, если подписок ещё не было.
- **from_event_sub** - Ошибка возникшая при подписке на события в серверном режиме
