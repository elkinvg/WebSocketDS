WebSocketDS
===========

- **[Installation](#installation)**

- **[Property list for defining Tango device](#property-list-for-defining-tango-device)**

- **[Attribute list](#attribute-list)**

- **[Description of the "Options" property](#description-of-the-options-property)**

- **[Device operating mode](#device-operating-mode)**

- **[Simple use only with reading attributes](#simple-use-only-with-reading-attributes)**
    - **[Reading attributes from the Tango Device](#reading-attributes-from-the-tango-device)**
    - **[Reading attributes from the TangoDevice group](#reading-attributes-from-the-tangodevice-group)**

- **[Reading from the pipe of connected devices](#reading-from-the-pipe-of-connected-devices)**
    - **[Reading from the pipe when updating data](#reading-from-the-pipe-when-updating-data)**
    - **[Reading from a pipe when requested](#reading-from-a-pipe-when-requested)**

- **[Additional parameters for attributes, pipe and commands](#additional-parameters-for-attributes-pipe-and-commands)**
    - **[Changing the  precision and formatting the output values of attributes, pipe, and commands](#changing-the-precision-and-formatting-the-output-values-of-attributes-pipe-and-commands)**
    - **[Setting the periodicity of the output of values for attributes](#setting-the-periodicity-of-the-output-of-values-for-attributes)**

- **[Running Commands](#running-commands)**
    - **[Running commands in server mode](#running-commands-in-server-mode)**
    - **[Running commands in group-server mode](#running-commands-in-group-server-mode)**
 
    - **[The format of the returned error messages](#the-format-of-the-returned-error-messages)**

## Installation

  For successful compilation, TANGO libraries and a compiler with support for c++11 should be installed. Also should be __installed libboost-system libboost-system-dev libssl__

  For successful compilation TANGO libraries and a c++11 compiler must be installed. __libboost-system libboost-system-dev libssl__ must also be installed.
The directory has Makefile for g++. This Makefile was generated by POGO, and is suitable in most cases of TANGO standard assembly. For successful running of Makefile, there must be a directory, defined in `MAKE_ENV = /usr/local/share/pogo/preferences` (default. Correct if necessary). The directory’s scripts contain the necessary environment variables for сборки проекта .
As a default, compilation runs in __OPTIMIZED (-O2)__ mode. For compilation in DEBUG (-g -D_DEBUG)  mode, start __make RTYPE=debug__, inputting make clean

## Property list for defining Tango device

  - **Mode** — Device operating mode; (string)  
  - **Port** — Listening port at connection; (DevShort)
  - **DeviceServer** - tango id of the used device. As template parameter may serve simple name of a device or name pattern for group (e.g., `domain_*/family/member_*`). `Used only if any server mode is selected.` ; (string)
  - **Attributes** — — a list of device attributes you want to read, if reading all attributes is required, add __all_attrs__ (not operational in group mode) `Used only if any server mode is selected.` ; (array of string)
  - **Commands** — a list of device commands you want to execute through WS. `Used only if any server mode is selected.` ; (array of string)
  - **PipeName** - Name of DevicePipe for reading. [0]
When using GROUP, the DevicePipe name must be the same for all devices.
If you want to set properties for specific attributes, add them in the format `NameAttr;property`
Used only if any server mode is selected. ; (array of string)
  - **AuthDS** — Tango web authentication device server (TangoWebAuth ) name.
Responsible for user authentication in case of commands execution ; (string)
  - **Secure** — Shall we use SSL encryption?
Set true, for secure wss connection, otherwise false;  (bool)
  - **Certificate** — Full path to the certificate in use (if Secure == true); (string)
  - **Key** - Full path to the file used with Private key (if Secure == true); (string)
  - **MaxNumberOfConnections** - maximum number of connections. If the limit is reached, further connections will be lost with `400 Bad Request error`. If 0 is set, the number of connections will be unlimited. ; (DevUShort)
  - **MaximumBufferSize** - maximum buffer size for each connection, KiB. The Default value is 1000. Possible values range from1 to 10000 (if setting a value outside the range, the default value will be set). If exceeding the set maximum buffer size, the connection will be lost by the server; (DevULong)
  - **ResetTimestampDifference** - The difference in timestamps (seconds) after which a WS server is reset. The difference is counted by CheckPoll method between update timestamp in UpdateData method and current timestamp. Minimum value is 60. 
Default and MinValue = 60
Used only if any server mode is selected ; (DevUShort)
  - **Options** - additional options. A list of additional options for the device. More information about the list of additional options will be [given below](#description-of-the-options-property). (array of string)

  <h2><b><font color="red"> CheckPoll method checks how many seconds have passed since the last run of UpdateData method. If the value exceeds the number of seconds set in property, device-server is reset . Do not set value polling for UpdateData close to value of ResetTimestampDifference. </font></b></h2>

## Attribute list

  - **JSON** - current JSON-output; (DevString)
  - **TimestampDiff** - Current timestamps difference (Updated in the CheckPoll method. The default value of Polling for CheckPoll method is 10 seconds); (DevULong)
  - **NumberOfConnections** - Current number of clients (connections). (DevULong)

## Description of the "Options" property

  List of available options:

  - **group** - Without additional values. Use of groups of devices. The `DeviceServer` property must be specified in the appropriate format for groups.
  - **uselog** - Without additional values. Use the logging when executing commands. 
  - **tident** - With additional values. Type of authorization that is used. There are three types `rndid` - RANDIDENT, `rndid2` - RANDIDENT2 и `rndid3` RANDIDENT3
  - **tm100ms** - Without additional values. By default, the minimum value for the update period set by the client should be greater than or equal to 1000 ms. When this option is set in Options, the minimum value is 100 ms.
  
  For option with additional values: `option=value`

## Device operating mode

Tango module works in one of the following modes:

  - **SERVER** - Only server control of the output of information read from the attributes and pipe. And also the execution of commands in the tango-module (or group), registered in the Property. In this mode, the module is started by default. mode:  `ser`.
  - **SERVNCLIENT_ALL_RO** - Server and client management of the output of information read from the attributes and pipe. And also the execution of commands in the tango-module (or group), registered in the Property; mode:  `ser_cli_all_ro`.
  - **SERVNCLIENT_ALL** - Server and client management of the output of information read from the attributes and pipe. Running the commands in the tango module (or group) specified in the Property. Also the execution of commands and reading of attributes from any tango modules; mode: `ser_cli_all`
  - **SERVNCLIENT_ALIAS_RO** - Server and client management of the output of information read from the attributes and pipe. Running the commands in the tango module (or group) specified in the Property. It is forbidden to run commands in the modules specified by the client. Reading attributes only from tango modules that have alias; option: `ser_cli_ali_ro`
  - **SERVNCLIENT_ALIAS** - Server and client management of the output of information read from the attributes and pipe. Running the commands in the tango module (or group) specified in the Property. Reading attributes and the execution of commands only from tango modules that have alias; mode: `ser_cli_ali`
  - **CLIENT_ALL_RO** - Client control of the output of information read from the attributes and pipe. When using this mode, only the user-defined data comes from the server. Also it is forbidden to run commands; mode: `cli_all_ro`
  - **CLIENT_ALL** - Client control of the output of information read from the attributes and pipe. When using this mode, only the user-defined data comes from the server. It is possible to start commands on any tango-modules; mode: `cli_all`
  - **CLIENT_ALIAS_RO** - Client control of the output of information read from attributes and pipe only from tango modules that have alias. When using this mode, only the user-defined data comes from the server.; mode: `cli_ali_ro`
  - **CLIENT_ALIAS** - Client control of the output of information read from attributes and pipe, only from tango modules that have alias. When using this mode, only the user-defined data comes from the server. It is also possible to run commands only from tango modules that have alias; mode: `cli_ali`

## Simple use only with reading attributes

`When using any of the server modes`

To use WS only for reading attributes, you must define `Port`,` DeviceServer` (or Group), and the list of `Attributes` to be read. If you use a secure wss connection, you need to set the `Secure` property to true, and also specify` Certificate` and `Key`.

[More information about JSON can be found here](http://www.json.org/)

#### Reading attributes from the Tango Device

By default the format of the received data will be as follows:
```json
{
	"event": "read",
	"type_req":"attribute",
	"data": [
		{
			"attr": "attribute_name",
			"data": "data"
		},
		{
			"attr": "attribute_name2",
			"data": ["data", "array"]
		},
	]
}
```

Also, values UNIX_TIMESTAMP `"time"` and `Tango::AttrQuality`` "qual" `can be added. By default, `Tango::AttrQuality` is displayed only if it is not equal to `VALID`.

```json
{
	"attr": "attribute_name",
	"qual": "VALID",
	"time": 1475580424,
	"data": 128
}
```

To add these values, add the value `notshrtatt` in the Property` "Options" ` ([More about the options format here](#description-of-the-options-property)).

  * **"event"** - Type of event, in this case it is `reading`
  * **"type_req"** - The type of data received, in this case it is attribute. Data from the listened attributes.
  * **"data"** - Gotten data. (Attributes)

    * **"attr"** — Name of the listened attribute.
    * **"qual"** — `Tango::AttrQuality` Possible Values: `"VALID`", `"INVALID"`,`"ALARM"`, `"CHANGING"`, `"WARNING"`;
    * **"time"** — UNIX_TIMESTAMP
    * **"data"** — Data. Depending on the type of attributes being read (Scalar, Spectrum, Image), the output format changes. For Scalar, this is the only value in the form of a string, a number, or a Boolean value. For Spectrum, it is an array of the form [...], and the value of `"dimX"` the dimension of the spectrum is also defined. For Image- this is an array of the form [...], also the value of `"dimX"` and `"dimY"` is the dimension of Image.

  If errors occur while reading the attributes, an error message is displayed in JSON format. The format is described below in the section `"[The format of the returned error messages](#the-format-of-the-returned-error-messages)"`

#### Reading attributes from the TangoDevice group

`When using any of the server modes`

An example of the format of the received data from the group of devices is as follows:

```json
{
	"event": "read",
	"type_req":"group_attribute",
	"data":
	{
		"name/tango/device_from_group" :
		[
			{
				"attr": "attribute_name",
				"data": "data"
			},
			{
				"attr": "attribute_name2",
				"data": ["data", "array"]
			},
		]
	}
}
```

If an error occurs when reading from a separate device from the group, the data format for it will be:

```json
{
	"name/tango/device_from_group" : "Error message"
}
```

## Reading from the pipe of connected devices

`When using any of the server modes`

Data comes in two cases:
  - The data from the pipe is read when the data is updated with the attributes and added to the corresponding JSON-output.
  - The data from the pipe is read at the request. The JSON-input is sent in the required format (described below).

#### Reading from the pipe when updating data

`When using any of the server modes`

PipeName has type `array of string`. To read data from the pipe of the connected devices in the attribute mode, the `pipe_name` - pipe name of the readable device must be added to the `PipeName[0]` property.
To format the output of individual pipe segments, you need to add lines with the names of the segment to the property, and the necessary types of formatting. 

In the attribute mode, you can connect to a single pipe from the device.

If there is a PipeName in the property, JSON adds values in the following format:

__In case of success:__

  a) __for device:__

  ```json
	{ "attribute_data" : "data",
		"pipe":
		{
			"attrName1" : "Data in format dependent on type",
			"attrName2" : ["Data in format", "dependent on type"]
		}
	}
  ```
  b) __for group:__

 ```json
	{ "attribute_data" : "data",
		"pipe":
		{
			"nameof/tango/device":
			{
				"attrName1" : "Data in format dependent on type",
				"attrName2" : ["Data in format", "dependent on type"]
			}
		}
	}
 ```

__In case of error:__

  a) __for device:__

   ```json
  { "attribute_data" : "data",
    "pipe" : "Error message"
  }
   ```

   b) __for group:__

   ```json
  { "attribute_data" : "data",
    "pipe":
    {
      "nameof/tango/device": "Error message"
    }
  }
   ```

 `"Error message"` - Can also be an array of messages in the format `["Message1", "Message2"]`

#### Reading from a pipe when requested

`When using any of the server modes`

To read from the pipe in command mode, send a JSON message in the following format:

```json
{     
	"type_req": "read_pipe or read_pipe_dev or read_pipe_gr",
	"pipe_name": "PipeName",
	"device_name": "!!!Only when reading from a specific device in a group mode!!!",
	"id": "Id to identify the request"
}
```

  * __"read_pipe or read_pipe_dev or read_pipe_gr"__:  Used `"read_pipe"` in the mode of one device. `"read_pipe_dev"` in the mode `group`, for reading from a specific device from the group. `"read_pipe_gr"` in the mode `group`, for reading from all devices from the group.
  * __"pipe_name"__: Name of reading pipe.
  * __"device_name"__: Name of device in mode `group`, for reading from a specific device from the group.
  * __"id"__: Identification of the request.  The value for id can be either a number or a string. In case the id is not specified, is returned `"id": "None"`.

To format the output of individual pipe segments, you need to add lines with the names of the segment to the property, and the necessary types of formatting.

  - The answer for `"read_pipe"` in single device mode:

  ```json
  {
  	"event": "read",
  	"type_req": "read_pipe",
  	"id_req": 1,
  	"data": {
  		"AttrName": "data",
  		"AttrName2": ["data", "data"]
  	}
  }
  ```

  - For `"read_pipe_dev"` in mode `group`:

  ```json
  {
  	"event": "read",
  	"type_req": "read_pipe_dev",
  	"device_name": "name/tango/device_from_group",
  	"id_req": "id",
  	"data": {
  		"AttrName": "data",
  		"AttrName2": ["data", "data"]
  	}
  }
  ```

  - For reading from all devices from the group `"read_pipe_gr"` in mode `group`:

  ```json
  {
  	"event": "read",
  	"type_req": "read_pipe_gr",
  	"device_name": "name/tango/device_from_group",
  	"id_req": "id",
  	"data" : {
  		"name/tango/device_from_group": {
  			"AttrName": "data",
  			"AttrName2": ["data", "data"]
  		},
  		"name/tango/other_device_from_group": "error messageо [or Message array]"
  	}
  }
  ```

 If the error occurs, depending on the operation mode and command type, the message is either added to the JSON-output for the group in the device partition where the error occurred, or the general error message is displayed in the format described below in the section "[The format of the returned error messages](#the-format-of-the-returned-error-messages)"

## Additional parameters for attributes, pipe and commands

To add additional parameters, add in the postfix property

```
CommandOrAttrName;par1=val
```

or for several parameters

```
CommandOrAttrName;par1=val;par2;par3=34
```

Where par - is parameter, val - is value if required.

For pipe from updating data (property PipeName):

```
PipeName
AttrName;par1=val;par2
```

In the case of pipe in command mode (when requested) , parameters for individual attributes are set to property `Commands`. The name of the attribute must be appended with `; pipecomm`, as well as the required parameter.

```
AttrName;pipecomm;par1=val;par2
```

List of currently available parameters for commands and attributes:

 - For attributes, commands and pipe: **precf**, **precs**, **prec**
 - Only for attributes: **niter**
 - Only for command: **bindata**
 
#### Changing the  precision and formatting the output values of attributes, pipe, and commands

By default, `setprecision(5)` is used to output attribute, pipe, and command data.

To set other  precision values, add a postfix `;prec=N` to the attribute name. 

N is the required precision.

```
AttributeOrCommandName;prec=10
```

It is also possible to set additional formatting flags:

- **precf** - Setting the flag std::fixed
- **precs** - Setting the flag std::scientific

Example output for 1476379200 (type double with precision = 10)

- **;prec=10** - output: 1476379200
- **;precf=10** - output: 1476379200.0000000000
- **;precs=10** - output: 1.4763792000e+009

Example output for 1476379200 (type double with precision  by default)
- **;precf** - output: 1476379200.000000
- **;precs** - output: 1.476379e+009

#### Setting the periodicity of the output of values for attributes

For individual attributes, you can set the frequency of the output. To set the periodicity for the attribute name in the property, add `;niter=N/M` or `;niter=N`

 - **N** - Output once in N iterations.  (unsigned short)
 - **M** - The iteration number at which the value is displayed.
 
`M` should be less than `N`


## Running commands

To run the commands, the user must send a json-message

```json
{
	"type_req": "Type of command",
	"id": "Request id",
	"command_name": "Command name",
	"argin" : "value or array"
}
```


#### Running commands in server mode

`When using any of the server modes`

```
"type_req": "command"
```

The answer in a successful case would be:

```json
{
	"event": "read",
	"type_req": "command",
	"id_req": "Request id",
	"data": {
		"command_name": "Command name",
		"argout": "value or array"
	}
}
```

#### Running commands in group-server mode

`When using any of the server modes`

For the whole group

```
"type_req": "command_group"
```

The answer in a successful case would be:

  ```json
  {
  	"event": "read",
  	"type_req": "command_group",
  	"id_req": "Request id",
  	"data": {
  		"command_name": "Command name",
  		"argout": {
  			"name/tango/device_from_group" : "value or array",
  			"name/tango/other_device_from_group": {
  				"errors": "Possible error message, or [message array]"
  			}
  		}
  	}
  }
  ```  

For a single device from the group

```
"type_req": "command_device"
```

The answer in a successful case would be:

  ```json
  {
  	"event": "read",
  	"type_req": "command_device",
  	"id_req": "Request id",
  	"data": {
  		"command_name": "Command name",
  		"device_name": "name/tango/device_from_group",
  		"argout": "value or array"
  	}
  }
  ```


In case of an error, the message in the format described below in the section "[The format of the returned error messages](#the-format-of-the-returned-error-messages)"



#### Common information about the commands

Running commands is only possible for registered users in the database.

Depending on the type of authorization, the client application should either have a url with additional parameters `ws(wss)://address:port?Additional_parameters` (for authorization types SIMPLE and RANDIDENT) or after connection, sending a request to server. (For authorization types RANDIDENT2 and RANDIDENT3)

The check is carried out through the TANGO device, registered in the `AuthDS` property.


## The format of the returned error messages

Reading attributes in server mode:

```json
{
	"event": "error",
	"type_req": "attribute",
	"err_mess": "Сообщение ошибки"
}
```

Other Requests:

```json
{
	"event": "error",
	"type_req": "Request Type",
	"name_req": "Request Name (If used)",
	"id_req": "Request id",
	"err_mess": "message or [Message array]"
}
```